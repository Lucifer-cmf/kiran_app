
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Management System (Local Storage)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4361ee; --secondary: #3f37c9; --success: #4cc9f0; --light: #f8f9fa; --dark: #212529;
            --admin: #7209b7; --manager: #f72585; --employee: #4cc9f0; --task-assigned: #3b82f6; 
            --task-completed: #10b981; --task-missed: #ef4444; --appreciation: #f59e0b;
        }
        body { background-color: #f5f7fb; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-x: hidden; }
        .auth-container { background: linear-gradient(135deg, #4361ee, #3a0ca3); height: 100vh; display: flex; align-items: center; justify-content: center; }
        .auth-card { background: rgba(255, 255, 255, 0.95); border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); width: 100%; max-width: 400px; overflow: hidden; }
        .dashboard-container { display: flex; min-height: 100vh; }
        .sidebar { background: linear-gradient(to bottom, var(--primary), var(--secondary)); width: 250px; min-height: 100vh; color: white; box-shadow: 3px 0 10px rgba(0, 0, 0, 0.1); transition: all 0.3s; z-index: 100; }
        .sidebar-header { padding: 20px; background: rgba(0, 0, 0, 0.15); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .user-info { padding: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .user-role { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; margin-top: 5px; }
        .role-admin { background: var(--admin); } .role-manager { background: var(--manager); } .role-employee { background: var(--employee); }
        .sidebar-menu { list-style: none; padding: 0; margin: 0; }
        .sidebar-menu li a { color: rgba(255, 255, 255, 0.8); padding: 12px 20px; display: block; text-decoration: none; transition: all 0.2s; border-left: 3px solid transparent; }
        .sidebar-menu li a:hover, .sidebar-menu li a.active { background: rgba(255, 255, 255, 0.1); color: white; border-left: 3px solid white; }
        .sidebar-menu li a i { width: 25px; text-align: center; margin-right: 10px; }
        .main-content { flex: 1; padding: 20px; background-color: #f0f4f8; position: relative; }
        .top-bar { background: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .dashboard-title { font-weight: 600; color: var(--dark); margin: 0; }
        .card { border-radius: 12px; border: none; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); margin-bottom: 20px; }
        .card-header { background: white; border-bottom: 1px solid rgba(0, 0, 0, 0.05); padding: 15px 20px; border-radius: 12px 12px 0 0 !important; font-weight: 600; }
        .employee-card { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #e9ecef; }
        .employee-card:last-child { border-bottom: none; }
        .employee-avatar { width: 50px; height: 50px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; margin-right: 15px; flex-shrink: 0; }
        .employee-info { flex: 1; }
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
        .mobile-menu-btn { display: none; background: none; border: none; color: var(--primary); font-size: 1.5rem; }
        @media (max-width: 992px) { .sidebar { position: fixed; left: -250px; } .sidebar.active { left: 0; } .mobile-menu-btn { display: block; } }
        .stat-card { text-align: center; padding: 20px; border-radius: 12px; color: white; margin-bottom: 20px; }
        .stat-1 { background: linear-gradient(135deg, #4361ee, #3a0ca3); } .stat-2 { background: linear-gradient(135deg, #f72585, #b5179e); }
        .stat-3 { background: linear-gradient(135deg, #4cc9f0, #4895ef); } .stat-4 { background: linear-gradient(135deg, #7209b7, #560bad); }
        .spinner-container { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #ffffff; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .alert-container { position: fixed; top: 20px; right: 20px; z-index: 1056; width: 350px; }
        .table-hover tbody tr:hover { background-color: rgba(67, 97, 238, 0.05); }
        .table-responsive { overflow-x: auto; }
        .badge-success { background-color: #2ecc71 !important; } .badge-warning { background-color: #f39c12 !important; } .badge-danger { background-color: #e74c3c !important; } .badge-info { background-color: #3498db !important; } .badge-primary { background-color: var(--primary) !important; }
        
        /* Tasks & Appreciation Styles */
        .task-card { border-left: 4px solid var(--task-assigned); margin-bottom: 15px; border-radius: 8px; }
        .task-card.completed { border-left-color: var(--task-completed); }
        .task-card.missed { border-left-color: var(--task-missed); }
        .task-status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
        .task-assigned { background-color: rgba(59, 130, 246, 0.15); color: var(--task-assigned); }
        .task-completed { background-color: rgba(16, 185, 129, 0.15); color: var(--task-completed); }
        .task-missed { background-color: rgba(239, 68, 68, 0.15); color: var(--task-missed); }
        .appreciation-card { background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 193, 7, 0.05)); border-left: 4px solid var(--appreciation); }
        .appreciation-badge { background: var(--appreciation); color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; }
        .clock-btn { transition: all 0.3s; }
        .clock-btn.clocked-in { background: var(--task-completed); }
        .clock-btn.clocked-out { background: var(--task-missed); }
        .task-actions .btn { margin-right: 5px; }
        .task-form .form-label { font-weight: 500; }
        .analytics-chart { height: 300px; position: relative; }
        .profile-pic { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); }
        .password-strength { height: 5px; margin-top: 5px; border-radius: 3px; }
        .strength-0 { background: #e74c3c; width: 20%; }
        .strength-1 { background: #f39c12; width: 40%; }
        .strength-2 { background: #f1c40f; width: 60%; }
        .strength-3 { background: #2ecc71; width: 80%; }
        .strength-4 { background: #27ae60; width: 100%; }
        .login-details { background: #e8f4fd; border-radius: 8px; padding: 15px; margin-top: 20px; }
        .login-details h5 { margin-top: 0; }
        .login-details ul { padding-left: 20px; margin-bottom: 0; }
        .login-details li { margin-bottom: 8px; }
        .login-details .role-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 5px; }
    </style>
</head>
<body>
    <div id="alert-container"></div>
    <div id="loading-spinner" class="spinner-container d-none"><div class="spinner"></div></div>

    <div id="auth-screen" class="auth-container">
        <div class="auth-card">
            <div class="text-center p-4" style="background: var(--primary);"><h3 class="text-white mb-0">Employee Management System</h3></div>
            <div class="p-4">
                <div class="mb-4 text-center"><img src="https://cdn-icons-png.flaticon.com/512/6146/6146587.png" alt="Login" style="width: 100px;"><h4 class="mt-3">Sign In to Dashboard</h4></div>
                <form id="login-form" onsubmit="return false;">
                    <div id="login-error" class="alert alert-danger d-none"></div>
                    <div class="mb-3"><label class="form-label">Email Address</label><input type="email" id="login-email" class="form-control" required></div>
                    <div class="mb-3"><label class="form-label">Password</label><input type="password" id="login-password" class="form-control" required></div>
                    <button type="button" id="login-btn" class="btn btn-primary w-100">Sign In</button>
                    <div class="text-center mt-3"><a href="#" id="setup-link">No account? Click here to setup demo data</a></div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="dashboard" class="d-none">
        <div class="dashboard-container">
            <div class="sidebar">
                <div class="sidebar-header"><h5 class="mb-0">Employee Management</h5></div>
                <div class="user-info">
                    <div class="d-flex align-items-center">
                        <div class="employee-avatar"><span id="user-initials"></span></div>
                        <div class="ms-3"><h6 class="mb-0" id="user-name"></h6><span class="user-role" id="user-role"></span></div>
                    </div>
                </div>
                <ul class="sidebar-menu" id="main-menu">
                    <li><a href="#" class="active" data-view="dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                    <li><a href="#" data-view="attendance"><i class="fas fa-calendar-check"></i> Attendance</a></li>
                    <li><a href="#" data-view="leave"><i class="fas fa-house-user"></i> Leave & WFH</a></li>
                    <li><a href="#" data-view="tasks"><i class="fas fa-tasks"></i> Tasks</a></li>
                    <li><a href="#" data-view="appreciations"><i class="fas fa-medal"></i> Appreciations</a></li>
                    <li><a href="#" data-view="analytics"><i class="fas fa-chart-bar"></i> Analytics</a></li>
                    <li class="admin-only"><a href="#" data-view="employees"><i class="fas fa-users-cog"></i> Employees</a></li>
                    <li><a href="#" data-view="profile"><i class="fas fa-user"></i> Profile</a></li>
                    <li><a href="#" data-view="password"><i class="fas fa-lock"></i> Change Password</a></li>
                    <li><a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                </ul>
            </div>
            <div class="main-content">
                <div class="top-bar">
                    <button class="mobile-menu-btn"><i class="fas fa-bars"></i></button>
                    <h4 class="dashboard-title" id="view-title">Dashboard</h4>
                    <div class="d-flex align-items-center">
                        <button id="clock-btn" class="btn btn-sm clock-btn me-2">Clock In</button>
                        <span id="current-date"></span>
                    </div>
                </div>
                
                <!-- Dashboard View -->
                <div class="view-content" id="dashboard-view">
                    <div class="row mb-4">
                        <div class="col-md-3"><div class="stat-card stat-1"><i class="fas fa-users fa-2x mb-2"></i><h3 class="mb-0" id="total-employees">0</h3><p class="mb-0">Total Employees</p></div></div>
                        <div class="col-md-3"><div class="stat-card stat-2"><i class="fas fa-calendar-day fa-2x mb-2"></i><h3 class="mb-0" id="present-today">0</h3><p class="mb-0">Present Today</p></div></div>
                        <div class="col-md-3"><div class="stat-card stat-3"><i class="fas fa-plane-departure fa-2x mb-2"></i><h3 class="mb-0" id="on-leave">0</h3><p class="mb-0">On Leave</p></div></div>
                        <div class="col-md-3"><div class="stat-card stat-4"><i class="fas fa-laptop-house fa-2x mb-2"></i><h3 class="mb-0" id="wfh-today">0</h3><p class="mb-0">Working Remotely</p></div></div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">Today's Employee Status</div>
                                <div class="card-body p-0" id="employee-status-container" style="max-height: 350px; overflow-y: auto;"></div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Your Tasks</span>
                                    <button class="btn btn-sm btn-outline-primary" id="add-task-btn">Add Task</button>
                                </div>
                                <div class="card-body p-0" id="user-tasks-container" style="max-height: 350px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Recent Appreciations</span>
                            <button class="btn btn-sm btn-outline-primary" id="add-appreciation-btn">Give Appreciation</button>
                        </div>
                        <div class="card-body" id="recent-appreciations"></div>
                    </div>
                </div>
                
                <!-- Attendance View -->
                <div class="view-content d-none" id="attendance-view">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Attendance Records</span>
                            <div>
                                <select class="form-select form-select-sm d-inline-block w-auto" id="attendance-month">
                                    <option value="0">January</option>
                                    <option value="1">February</option>
                                    <option value="2">March</option>
                                    <option value="3">April</option>
                                    <option value="4">May</option>
                                    <option value="5">June</option>
                                    <option value="6">July</option>
                                    <option value="7">August</option>
                                    <option value="8">September</option>
                                    <option value="9">October</option>
                                    <option value="10">November</option>
                                    <option value="11">December</option>
                                </select>
                                <select class="form-select form-select-sm d-inline-block w-auto ms-2" id="attendance-year">
                                    <option>2023</option>
                                    <option selected>2024</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Clock In</th>
                                            <th>Clock Out</th>
                                            <th>Total Hours</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attendance-table"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Leave & WFH View -->
                <div class="view-content d-none" id="leave-view">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">Apply for Leave/WFH</div>
                                <div class="card-body">
                                    <form id="leave-form">
                                        <div class="mb-3">
                                            <label class="form-label">Type</label>
                                            <select class="form-select" id="leave-type">
                                                <option value="leave">Leave</option>
                                                <option value="wfh">Work From Home</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Start Date</label>
                                            <input type="date" class="form-control" id="leave-start" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">End Date</label>
                                            <input type="date" class="form-control" id="leave-end" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Reason</label>
                                            <textarea class="form-control" id="leave-reason" rows="3" required></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Submit Request</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">Your Requests</div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Type</th>
                                                    <th>Date</th>
                                                    <th>Reason</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="leave-requests-table"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header">Pending Approvals (Admin/Manager)</div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Employee</th>
                                                    <th>Type</th>
                                                    <th>Date</th>
                                                    <th>Reason</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="pending-approvals-table"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tasks View -->
                <div class="view-content d-none" id="tasks-view">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Your Tasks</span>
                                    <button class="btn btn-sm btn-primary" id="add-task-btn-2">Add Task</button>
                                </div>
                                <div class="card-body" id="user-tasks-container-2"></div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Team Tasks</span>
                                    <div class="btn-group">
                                        <select class="form-select form-select-sm" id="task-filter">
                                            <option value="all">All Tasks</option>
                                            <option value="assigned">Assigned</option>
                                            <option value="completed">Completed</option>
                                            <option value="missed">Missed</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="card-body" id="team-tasks-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Appreciations View -->
                <div class="view-content d-none" id="appreciations-view">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Give Appreciation</span>
                                </div>
                                <div class="card-body">
                                    <form id="appreciation-form">
                                        <div class="mb-3">
                                            <label class="form-label">Employee</label>
                                            <select class="form-select" id="appreciation-employee" required>
                                                <option value="">Select Employee</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Task</label>
                                            <select class="form-select" id="appreciation-task" required>
                                                <option value="">Select Task</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Appreciation Note</label>
                                            <textarea class="form-control" id="appreciation-note" rows="3" placeholder="Write your appreciation message..." required></textarea>
                                        </div>
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="appreciation-public" checked>
                                            <label class="form-check-label">Make this appreciation public to the team</label>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Submit Appreciation</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Team Appreciations</span>
                                    <div class="btn-group">
                                        <select class="form-select form-select-sm" id="appreciation-filter">
                                            <option value="all">All Appreciations</option>
                                            <option value="public">Public Only</option>
                                            <option value="mine">My Appreciations</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="card-body" id="team-appreciations-container" style="max-height: 500px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Analytics View -->
                <div class="view-content d-none" id="analytics-view">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">Weekly Attendance Analytics</div>
                                <div class="card-body">
                                    <div class="analytics-chart">
                                        <canvas id="attendance-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">Task Completion Rate</div>
                                <div class="card-body">
                                    <div class="analytics-chart">
                                        <canvas id="tasks-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">Leave & WFH Distribution</div>
                                <div class="card-body">
                                    <div class="analytics-chart">
                                        <canvas id="leave-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">Monthly Performance</div>
                                <div class="card-body">
                                    <div class="analytics-chart">
                                        <canvas id="performance-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Employees View -->
                <div class="view-content d-none" id="employees-view">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center"><span>Employee List</span><button class="btn btn-primary btn-sm" id="add-employee-btn"><i class="fas fa-plus me-1"></i> Add Employee</button></div>
                        <div class="card-body"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>Name</th><th>Email</th><th>Department</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead><tbody id="employees-table"></tbody></table></div></div>
                    </div>
                </div>
                
                <!-- Profile View -->
                <div class="view-content d-none" id="profile-view">
                    <div class="card">
                        <div class="card-header">Your Profile</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 text-center">
                                    <img src="https://ui-avatars.com/api/?name=User+Name&background=4361ee&color=fff" alt="Profile" class="profile-pic mb-3">
                                    <button class="btn btn-outline-primary btn-sm w-100">Change Photo</button>
                                </div>
                                
                                <div class="col-md-9">
                                    <form id="profile-form">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">First Name</label>
                                                <input type="text" class="form-control" id="profile-first-name" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Last Name</label>
                                                <input type="text" class="form-control" id="profile-last-name" required>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Email</label>
                                                <input type="email" class="form-control" id="profile-email" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Phone</label>
                                                <input type="tel" class="form-control" id="profile-phone">
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Department</label>
                                                <select class="form-select" id="profile-department" required>
                                                    <option value="hr">HR</option>
                                                    <option value="developer">Developer</option>
                                                    <option value="web-developer">Web Developer</option>
                                                    <option value="graphic-designer">Graphic Designer</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Date of Birth</label>
                                                <input type="date" class="form-control" id="profile-dob">
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Address</label>
                                            <textarea class="form-control" id="profile-address" rows="2"></textarea>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary">Update Profile</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Change Password View -->
                <div class="view-content d-none" id="password-view">
                    <div class="card">
                        <div class="card-header">Change Password</div>
                        <div class="card-body">
                            <form id="password-form">
                                <div class="mb-3">
                                    <label class="form-label">Current Password</label>
                                    <input type="password" class="form-control" id="current-password" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">New Password</label>
                                    <input type="password" class="form-control" id="new-password" required>
                                    <div class="password-strength mt-1" id="password-strength"></div>
                                    <small class="text-muted">Password must be at least 8 characters long and include uppercase, lowercase, number, and special character.</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Confirm New Password</label>
                                    <input type="password" class="form-control" id="confirm-password" required>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">Change Password</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Settings View -->
                <div class="view-content d-none" id="settings-view">
                    <div class="card">
                        <div class="card-header">Data Management</div>
                        <div class="card-body"><p class="text-muted">This will reset all employees to the original 3 demo users. Any new employees you have added will be removed.</p><button class="btn btn-outline-danger" id="reset-data-btn"><i class="fas fa-database me-2"></i> Reset Demo Data</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="employeeModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="employeeModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="employee-form" onsubmit="return false;">
                <input type="hidden" id="employee-id">
                <div class="row mb-3">
                    <div class="col-md-6"><label class="form-label">First Name</label><input type="text" class="form-control" id="employee-first-name" required></div>
                    <div class="col-md-6"><label class="form-label">Last Name</label><input type="text" class="form-control" id="employee-last-name" required></div>
                </div>
                <div class="mb-3"><label class="form-label">Email</label><input type="email" class="form-control" id="employee-email" required></div>
                <div class="mb-3"><label class="form-label">Department</label><select class="form-select" id="employee-department" required><option value="">Select...</option><option value="hr">HR</option><option value="developer">Developer</option><option value="web-developer">Web Developer</option><option value="graphic-designer">Graphic Designer</option></select></div>
                <div class="mb-3"><label class="form-label">Role</label><select class="form-select" id="employee-role" required><option value="">Select...</option><option value="employee">Employee</option><option value="manager">Manager</option><option value="admin">Admin</option></select></div>
                <div class="mb-3" id="password-field-group"><label class="form-label">Password</label><input type="password" class="form-control" id="employee-password" required minlength="6"><small class="text-muted">Min. 6 characters.</small></div>
                <div class="mb-3 d-none" id="status-field-group"><label class="form-label">Status</label><select class="form-select" id="employee-status"><option value="active">Active</option><option value="inactive">Inactive</option></select></div>
            </form>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary" id="save-employee-btn">Save</button></div>
    </div></div></div>

    <div class="modal fade" id="taskModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="taskModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="task-form">
                <input type="hidden" id="task-id">
                <div class="mb-3">
                    <label class="form-label">Task Title</label>
                    <input type="text" class="form-control" id="task-title" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="task-description" rows="3" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Assign To</label>
                    <select class="form-select" id="task-assignee" required>
                        <option value="">Select Employee</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Deadline</label>
                    <input type="date" class="form-control" id="task-deadline" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Priority</label>
                    <select class="form-select" id="task-priority">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary" id="save-task-btn">Save Task</button></div>
    </div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentUser = null;
        let employeeModal = null;
        let taskModal = null;
        let clockedIn = false;
        let clockInTime = null;
        
        const DOMElements = {
            loadingSpinner: document.getElementById('loading-spinner'),
            authScreen: document.getElementById('auth-screen'),
            dashboard: document.getElementById('dashboard'),
            loginBtn: document.getElementById('login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            viewLinks: document.querySelectorAll('.sidebar-menu a'),
            viewContents: document.querySelectorAll('.view-content'),
            viewTitle: document.getElementById('view-title'),
            employeeForm: document.getElementById('employee-form'),
            saveEmployeeBtn: document.getElementById('save-employee-btn'),
            addEmployeeBtn: document.getElementById('add-employee-btn'),
            resetDataBtn: document.getElementById('reset-data-btn'),
            setupLink: document.getElementById('setup-link'),
            clockBtn: document.getElementById('clock-btn'),
            addTaskBtn: document.getElementById('add-task-btn'),
            addTaskBtn2: document.getElementById('add-task-btn-2'),
            addAppreciationBtn: document.getElementById('add-appreciation-btn'),
            taskForm: document.getElementById('task-form'),
            saveTaskBtn: document.getElementById('save-task-btn'),
            appreciationForm: document.getElementById('appreciation-form'),
            leaveForm: document.getElementById('leave-form'),
            profileForm: document.getElementById('profile-form'),
            passwordForm: document.getElementById('password-form'),
        };

        // =================================================================
        // == LOCAL STORAGE DATABASE
        // =================================================================
        const db = {
            getEmployees: () => {
                return JSON.parse(localStorage.getItem('employees')) || [];
            },
            saveEmployees: (employees) => {
                localStorage.setItem('employees', JSON.stringify(employees));
            },
            getTasks: () => {
                return JSON.parse(localStorage.getItem('tasks')) || [];
            },
            saveTasks: (tasks) => {
                localStorage.setItem('tasks', JSON.stringify(tasks));
            },
            getAppreciations: () => {
                return JSON.parse(localStorage.getItem('appreciations')) || [];
            },
            saveAppreciations: (appreciations) => {
                localStorage.setItem('appreciations', JSON.stringify(appreciations));
            },
            getLeaves: () => {
                return JSON.parse(localStorage.getItem('leaves')) || [];
            },
            saveLeaves: (leaves) => {
                localStorage.setItem('leaves', JSON.stringify(leaves));
            },
            getAttendance: () => {
                return JSON.parse(localStorage.getItem('attendance')) || [];
            },
            saveAttendance: (attendance) => {
                localStorage.setItem('attendance', JSON.stringify(attendance));
            },
            getCurrentUser: () => {
                return JSON.parse(sessionStorage.getItem('currentUser'));
            },
            setCurrentUser: (user) => {
                if (user) {
                    sessionStorage.setItem('currentUser', JSON.stringify(user));
                } else {
                    sessionStorage.removeItem('currentUser');
                }
            },
            init: () => {
                if (!localStorage.getItem('employees')) {
                    db.reset();
                }
                
                // Initialize demo data for tasks, appreciations, leaves, and attendance
                if (!localStorage.getItem('tasks')) {
                    const tasks = [
                        { id: 1, title: "Complete Q2 Report", description: "Prepare quarterly financial report", assignee: 3, assignedBy: 1, deadline: "2024-07-15", priority: "high", status: "completed", appreciation: { note: "Excellent work on the report!", givenBy: 1, date: "2024-07-15", public: true } },
                        { id: 2, title: "Client Onboarding", description: "Prepare documentation for new client", assignee: 3, assignedBy: 2, deadline: "2024-07-25", priority: "medium", status: "assigned" },
                        { id: 3, title: "Website Redesign", description: "Complete homepage redesign", assignee: 2, assignedBy: 1, deadline: "2024-07-10", priority: "high", status: "completed", appreciation: { note: "Great design work!", givenBy: 1, date: "2024-07-11", public: true } },
                        { id: 4, title: "SEO Optimization", description: "Implement SEO recommendations", assignee: 2, assignedBy: 1, deadline: "2024-07-05", priority: "medium", status: "missed" },
                        { id: 5, title: "Server Migration", description: "Migrate to new data center", assignee: 3, assignedBy: 2, deadline: "2024-07-30", priority: "high", status: "assigned" }
                    ];
                    db.saveTasks(tasks);
                }
                
                if (!localStorage.getItem('appreciations')) {
                    const appreciations = [
                        { id: 1, employeeId: 3, taskId: 1, note: "Excellent work on the Q2 Financial Report! Very detailed and insightful.", givenBy: 1, date: "2024-07-15", public: true },
                        { id: 2, employeeId: 2, taskId: 3, note: "Design team delivered an outstanding website redesign ahead of schedule!", givenBy: 1, date: "2024-07-11", public: true },
                        { id: 3, employeeId: 3, taskId: 2, note: "Great job handling the client onboarding process smoothly.", givenBy: 2, date: "2024-07-18", public: true }
                    ];
                    db.saveAppreciations(appreciations);
                }
                
                if (!localStorage.getItem('leaves')) {
                    const leaves = [
                        { id: 1, employeeId: 3, type: "wfh", startDate: "2024-07-10", endDate: "2024-07-12", reason: "Home renovation", status: "approved" },
                        { id: 2, employeeId: 2, type: "leave", startDate: "2024-07-20", endDate: "2024-07-22", reason: "Family event", status: "pending" },
                        { id: 3, employeeId: 1, type: "wfh", startDate: "2024-07-05", endDate: "2024-07-05", reason: "Doctor appointment", status: "approved" }
                    ];
                    db.saveLeaves(leaves);
                }
                
                if (!localStorage.getItem('attendance')) {
                    const attendance = [
                        { employeeId: 1, date: "2024-07-01", clockIn: "09:05", clockOut: "17:30", status: "present" },
                        { employeeId: 1, date: "2024-07-02", clockIn: "08:55", clockOut: "17:45", status: "present" },
                        { employeeId: 1, date: "2024-07-03", clockIn: "09:15", clockOut: "17:20", status: "present" },
                        { employeeId: 1, date: "2024-07-04", clockIn: "09:00", clockOut: "17:00", status: "present" },
                        { employeeId: 1, date: "2024-07-05", clockIn: "10:00", clockOut: "16:00", status: "wfh" },
                        { employeeId: 2, date: "2024-07-01", clockIn: "09:10", clockOut: "17:20", status: "present" },
                        { employeeId: 2, date: "2024-07-02", clockIn: "09:00", clockOut: "17:30", status: "present" },
                        { employeeId: 2, date: "2024-07-03", clockIn: "09:05", clockOut: "17:25", status: "present" },
                        { employeeId: 2, date: "2024-07-04", clockIn: "09:20", clockOut: "17:10", status: "present" },
                        { employeeId: 3, date: "2024-07-01", clockIn: "08:50", clockOut: "17:40", status: "present" },
                        { employeeId: 3, date: "2024-07-02", clockIn: "09:00", clockOut: "17:30", status: "present" },
                        { employeeId: 3, date: "2024-07-03", clockIn: "08:55", clockOut: "17:35", status: "present" },
                        { employeeId: 3, date: "2024-07-04", clockIn: "09:10", clockOut: "17:20", status: "present" },
                        { employeeId: 3, date: "2024-07-05", clockIn: "09:00", clockOut: "17:00", status: "present" }
                    ];
                    db.saveAttendance(attendance);
                }
            },
            reset: () => {
                 const initialUsers = [
                    { id: 1, firstName: 'Srini', lastName: 'G', email: 'srini@ay-technologies.com', password: 'password123', department: 'hr', role: 'admin', status: 'active', joinDate: new Date().toISOString() },
                    { id: 2, firstName: 'Vamsi', lastName: 'Krishna', email: 'vamsi@ay-technologies.com', password: 'password123', department: 'web-developer', role: 'manager', status: 'active', joinDate: new Date().toISOString() },
                    { id: 3, firstName: 'Sai', lastName: 'Kiran', email: 'kiran@ay-technologies.com', password: 'password123', department: 'web-developer', role: 'employee', status: 'active', joinDate: new Date().toISOString() }
                ];
                db.saveEmployees(initialUsers);
                
                // Reset other data
                localStorage.removeItem('tasks');
                localStorage.removeItem('appreciations');
                localStorage.removeItem('leaves');
                localStorage.removeItem('attendance');
                db.init();
            }
        };

        // =================================================================
        // == APP INITIALIZATION
        // =================================================================
        document.addEventListener('DOMContentLoaded', () => {
            db.init();
            employeeModal = new bootstrap.Modal(document.getElementById('employeeModal'));
            taskModal = new bootstrap.Modal(document.getElementById('taskModal'));
            
            // Check for a logged-in user in the session
            currentUser = db.getCurrentUser();
            if (currentUser) {
                showDashboard();
            } else {
                showAuthScreen();
            }
            
            // Setup event listeners for login screen
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('setup-link').addEventListener('click', (e) => {
                e.preventDefault();
                if(confirm("This will set up the default demo users. Any existing data will be erased. Proceed?")){
                    db.reset();
                    showAlert("Demo data has been set up. You can now log in.", "success");
                }
            });
        });

        function setupEventListeners() {
            DOMElements.logoutBtn.addEventListener('click', handleLogout);
            DOMElements.addEmployeeBtn.addEventListener('click', openEmployeeModalForAdd);
            DOMElements.saveEmployeeBtn.addEventListener('click', handleSaveEmployee);
            DOMElements.resetDataBtn.addEventListener('click', () => {
                if (confirm("Are you sure you want to reset all data to the default demo users?")) {
                    db.reset();
                    showAlert("Demo data has been reset.", "success");
                    loadEmployees();
                    loadDashboardStats();
                    loadEmployeeStatus();
                }
            });

            DOMElements.viewLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    if(link.id === 'logout-btn') return;
                    DOMElements.viewLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    const viewName = link.dataset.view;
                    DOMElements.viewTitle.textContent = link.textContent.trim();
                    DOMElements.viewContents.forEach(view => view.classList.add('d-none'));
                    document.getElementById(`${viewName}-view`).classList.remove('d-none');
                    loadViewData(viewName);
                });
            });
            
            DOMElements.clockBtn.addEventListener('click', toggleClock);
            DOMElements.addTaskBtn.addEventListener('click', openTaskModal);
            DOMElements.addTaskBtn2.addEventListener('click', openTaskModal);
            DOMElements.saveTaskBtn.addEventListener('click', handleSaveTask);
            DOMElements.addAppreciationBtn.addEventListener('click', () => {
                // Switch to appreciations view and show form
                document.querySelectorAll('.sidebar-menu a').forEach(l => l.classList.remove('active'));
                document.querySelector('[data-view="appreciations"]').classList.add('active');
                DOMElements.viewContents.forEach(view => view.classList.add('d-none'));
                document.getElementById('appreciations-view').classList.remove('d-none');
                DOMElements.viewTitle.textContent = "Appreciations";
                loadAppreciationFormData();
            });
            
            DOMElements.appreciationForm.addEventListener('submit', handleSaveAppreciation);
            DOMElements.leaveForm.addEventListener('submit', handleSaveLeave);
            DOMElements.profileForm.addEventListener('submit', handleSaveProfile);
            DOMElements.passwordForm.addEventListener('submit', handleChangePassword);
            
            document.getElementById('task-filter').addEventListener('change', loadTeamTasks);
            document.getElementById('appreciation-filter').addEventListener('change', loadTeamAppreciations);
            
            const now = new Date();
            document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            document.getElementById('attendance-month').value = now.getMonth();
            document.getElementById('attendance-year').value = now.getFullYear();

            // Mobile menu button
            document.querySelector('.mobile-menu-btn').addEventListener('click', () => {
                document.querySelector('.sidebar').classList.toggle('active');
            });
            
            // Password strength indicator
            document.getElementById('new-password').addEventListener('input', function() {
                const strength = calculatePasswordStrength(this.value);
                const strengthBar = document.getElementById('password-strength');
                strengthBar.className = 'password-strength strength-' + strength;
            });
        }

        function calculatePasswordStrength(password) {
            let strength = 0;
            if (password.length >= 8) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[a-z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            return Math.min(strength, 4);
        }

        function handleLogin() {
            const email = document.getElementById('login-email').value.toLowerCase();
            const password = document.getElementById('login-password').value;
            if (!email || !password) { showAlert('Email and password are required.', 'warning'); return; }

            const employees = db.getEmployees();
            const foundUser = employees.find(emp => emp.email.toLowerCase() === email && emp.password === password);

            if (foundUser) {
                if (foundUser.status === 'active') {
                    currentUser = foundUser;
                    db.setCurrentUser(currentUser);
                    showDashboard();
                } else {
                    showAlert('Your account is inactive.', 'danger');
                }
            } else {
                showAlert('Invalid email or password.', 'danger');
            }
        }
        
        function handleLogout() {
            currentUser = null;
            db.setCurrentUser(null);
            // Redirect to auth screen and remove event listeners
            window.location.reload();
        }

        function showDashboard() {
            DOMElements.authScreen.classList.add('d-none');
            DOMElements.dashboard.classList.remove('d-none');
            updateUIForUserRole();
            loadViewData('dashboard');
            setupEventListeners();
        }

        function showAuthScreen() {
            DOMElements.dashboard.classList.add('d-none');
            DOMElements.authScreen.classList.remove('d-none');
        }

        // =================================================================
        // == UI & DATA DISPLAY
        // =================================================================
        function updateUIForUserRole() {
            if (!currentUser) return;
            document.getElementById('user-name').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
            document.getElementById('user-initials').textContent = `${currentUser.firstName.charAt(0)}${currentUser.lastName.charAt(0)}`;
            const roleEl = document.getElementById('user-role');
            roleEl.textContent = currentUser.role;
            roleEl.className = `user-role role-${currentUser.role}`;
            document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('d-none', currentUser.role !== 'admin'));
        }

        function loadViewData(viewName) {
            switch(viewName) {
                case 'dashboard': 
                    loadDashboardStats(); 
                    loadEmployeeStatus(); 
                    loadUserTasks();
                    loadRecentAppreciations();
                    break;
                case 'attendance': 
                    loadAttendanceRecords(); 
                    break;
                case 'leave': 
                    loadLeaveRequests(); 
                    loadPendingApprovals();
                    break;
                case 'tasks': 
                    loadUserTasks(); 
                    loadTeamTasks(); 
                    break;
                case 'appreciations': 
                    loadAppreciationFormData();
                    loadTeamAppreciations(); 
                    break;
                case 'analytics': 
                    loadAnalyticsCharts(); 
                    break;
                case 'employees': 
                    if(currentUser.role === 'admin') loadEmployees(); 
                    break;
                case 'profile': 
                    loadProfileData(); 
                    break;
                case 'password': 
                    // Nothing to load initially
                    break;
            }
        }

        function loadDashboardStats() {
            const employees = db.getEmployees().filter(e => e.status === 'active');
            document.getElementById('total-employees').textContent = employees.length;
            document.getElementById('present-today').textContent = db.getAttendance().filter(a => a.date === new Date().toISOString().split('T')[0]).length;
            document.getElementById('on-leave').textContent = db.getLeaves().filter(l => l.status === 'approved' && l.type === 'leave').length;
            document.getElementById('wfh-today').textContent = db.getLeaves().filter(l => l.status === 'approved' && l.type === 'wfh').length;
        }

        function loadEmployeeStatus() {
            const container = document.getElementById('employee-status-container');
            container.innerHTML = '';
            const employees = db.getEmployees().filter(e => e.status === 'active');
            
            if (employees.length === 0) { container.innerHTML = `<div class="text-center py-4 text-muted">No active employees found.</div>`; return; }
            employees.forEach(employee => {
                const status = ['Present', 'On Leave', 'WFH', 'Absent'][Math.floor(Math.random() * 4)];
                const statusClass = { Present: 'success', 'On Leave': 'info', WFH: 'warning', Absent: 'danger' }[status];
                container.innerHTML += `<div class="employee-card">
                    <div class="employee-avatar">${employee.firstName.charAt(0)}${employee.lastName.charAt(0)}</div>
                    <div class="employee-info"><h6 class="mb-0">${employee.firstName} ${employee.lastName}</h6><small class="text-muted">${employee.department.replace('-', ' ')}</small></div>
                    <span class="status-badge bg-${statusClass}">${status}</span></div>`;
            });
        }
        
        function loadUserTasks() {
            const container = document.getElementById('user-tasks-container');
            const container2 = document.getElementById('user-tasks-container-2');
            if (!container || !container2) return;
            
            container.innerHTML = '';
            container2.innerHTML = '';
            
            const tasks = db.getTasks().filter(task => task.assignee == currentUser.id);
            
            if (tasks.length === 0) {
                const noTasksHtml = `<div class="text-center p-4 text-muted">No tasks assigned to you.</div>`;
                container.innerHTML = noTasksHtml;
                container2.innerHTML = noTasksHtml;
                return;
            }
            
            tasks.forEach(task => {
                const assigner = db.getEmployees().find(e => e.id == task.assignedBy) || {firstName: 'N/A'};
                const taskHtml = `
                    <div class="task-card p-3 mb-2 ${task.status}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">${task.title}</h6>
                            <span class="task-status-badge task-${task.status}">${task.status}</span>
                        </div>
                        <p class="mb-2">${task.description}</p>
                        <div class="d-flex justify-content-between text-muted small mb-2">
                            <span><i class="fas fa-user me-1"></i> ${assigner.firstName}</span>
                            <span><i class="fas fa-calendar me-1"></i> ${task.deadline}</span>
                            <span><i class="fas fa-flag me-1"></i> ${task.priority}</span>
                        </div>
                        ${task.status === 'assigned' ? `
                        <div class="d-flex">
                            <button class="btn btn-sm btn-success me-2 complete-task" data-id="${task.id}">Complete</button>
                            <button class="btn btn-sm btn-outline-secondary request-extension" data-id="${task.id}">Extend Deadline</button>
                        </div>` : ''}
                        ${task.appreciation ? `
                        <div class="appreciation-card mt-2 p-2">
                            <div class="d-flex align-items-center mb-1">
                                <span class="appreciation-badge me-2"><i class="fas fa-star"></i> Appreciation</span>
                                <small>${task.appreciation.date}</small>
                            </div>
                            <p class="mb-0">${task.appreciation.note}</p>
                        </div>` : ''}
                    </div>`;
                
                container.innerHTML += taskHtml;
                container2.innerHTML += taskHtml;
            });
            
            // Add event listeners to task buttons
            document.querySelectorAll('.complete-task').forEach(btn => {
                btn.addEventListener('click', () => markTaskComplete(btn.dataset.id));
            });
            
            document.querySelectorAll('.request-extension').forEach(btn => {
                btn.addEventListener('click', () => requestExtension(btn.dataset.id));
            });
        }
        
        function requestExtension(taskId) {
            showAlert("Extension requested for task. A notification will be sent to your manager.", "info");
        }
        
        function loadTeamTasks() {
            const container = document.getElementById('team-tasks-container');
            if (!container) return;
            
            container.innerHTML = '';
            const filter = document.getElementById('task-filter').value;
            let tasks = db.getTasks();
            
            if (filter !== 'all') {
                tasks = tasks.filter(task => task.status === filter);
            }
            
            if (tasks.length === 0) {
                container.innerHTML = `<div class="text-center p-4 text-muted">No tasks found for this filter.</div>`;
                return;
            }
            
            tasks.forEach(task => {
                const assignee = db.getEmployees().find(e => e.id == task.assignee) || {firstName: 'N/A', lastName: ''};
                const assigner = db.getEmployees().find(e => e.id == task.assignedBy) || {firstName: 'N/A'};
                const canGiveAppreciation = ['admin', 'manager'].includes(currentUser.role) && task.status === 'completed' && !task.appreciation;
                
                container.innerHTML += `
                    <div class="task-card p-3 mb-3 ${task.status}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">${task.title}</h6>
                            <span class="task-status-badge task-${task.status}">${task.status}</span>
                        </div>
                        <p class="mb-2">${task.description}</p>
                        <div class="d-flex justify-content-between text-muted small mb-2">
                            <span><i class="fas fa-user me-1"></i> ${assignee.firstName} ${assignee.lastName}</span>
                            <span><i class="fas fa-user-tie me-1"></i> ${assigner.firstName}</span>
                            <span><i class="fas fa-calendar me-1"></i> ${task.deadline}</span>
                        </div>
                        ${canGiveAppreciation ? `
                        <button class="btn btn-sm btn-warning give-appreciation" data-taskid="${task.id}" data-employeeid="${task.assignee}">
                            <i class="fas fa-medal me-1"></i> Give Appreciation
                        </button>` : ''}
                        ${task.appreciation ? `
                        <div class="appreciation-card mt-2 p-2">
                            <div class="d-flex align-items-center mb-1">
                                <span class="appreciation-badge me-2"><i class="fas fa-star"></i> Appreciation</span>
                                <small>${task.appreciation.date}</small>
                            </div>
                            <p class="mb-0">${task.appreciation.note}</p>
                        </div>` : ''}
                    </div>`;
            });
            
            document.querySelectorAll('.give-appreciation').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelector('[data-view="appreciations"]').click();
                    setTimeout(() => {
                        document.getElementById('appreciation-task').value = btn.dataset.taskid;
                        document.getElementById('appreciation-employee').value = btn.dataset.employeeid;
                    }, 100);
                });
            });
        }
        
        function loadRecentAppreciations() {
            const container = document.getElementById('recent-appreciations');
            if (!container) return;
            
            container.innerHTML = '';
            const appreciations = db.getAppreciations().slice(-3).reverse();
            
            if (appreciations.length === 0) {
                container.innerHTML = `<div class="text-center p-4 text-muted">No appreciations yet.</div>`;
                return;
            }
            
            appreciations.forEach(app => {
                const employee = db.getEmployees().find(e => e.id == app.employeeId) || {};
                const givenBy = db.getEmployees().find(e => e.id == app.givenBy) || {};
                const task = db.getTasks().find(t => t.id == app.taskId) || {};
                
                container.innerHTML += `
                    <div class="appreciation-card p-3 mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <span class="appreciation-badge me-2"><i class="fas fa-star"></i> Appreciation</span>
                                <small>${app.date}</small>
                            </div>
                            <small>${app.public ? 'Public' : 'Private'}</small>
                        </div>
                        <p class="mb-1">${app.note}</p>
                        <div class="d-flex justify-content-between text-muted small">
                            <span><i class="fas fa-user me-1"></i> ${employee.firstName} ${employee.lastName}</span>
                            <span><i class="fas fa-user-tie me-1"></i> ${givenBy.firstName} ${givenBy.lastName}</span>
                            <span><i class="fas fa-tasks me-1"></i> ${task.title || 'Task'}</span>
                        </div>
                    </div>`;
            });
        }
        
        function loadTeamAppreciations() {
            const container = document.getElementById('team-appreciations-container');
            if (!container) return;
            
            container.innerHTML = '';
            const filter = document.getElementById('appreciation-filter').value;
            let appreciations = db.getAppreciations();
            
            if (filter === 'public') appreciations = appreciations.filter(app => app.public);
            else if (filter === 'mine') appreciations = appreciations.filter(app => app.givenBy == currentUser.id);
            
            if (appreciations.length === 0) {
                container.innerHTML = `<div class="text-center p-4 text-muted">No appreciations found.</div>`;
                return;
            }
            
            appreciations.reverse().forEach(app => { // Show newest first
                const employee = db.getEmployees().find(e => e.id == app.employeeId) || {};
                const givenBy = db.getEmployees().find(e => e.id == app.givenBy) || {};
                const task = db.getTasks().find(t => t.id == app.taskId) || {};
                
                container.innerHTML += `
                    <div class="appreciation-card p-3 mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <span class="appreciation-badge me-2"><i class="fas fa-star"></i> Appreciation</span>
                                <small>${app.date}</small>
                            </div>
                            <small>${app.public ? 'Public' : 'Private'}</small>
                        </div>
                        <p class="mb-1">${app.note}</p>
                        <div class="d-flex justify-content-between text-muted small">
                            <span><i class="fas fa-user me-1"></i> ${employee.firstName} ${employee.lastName}</span>
                            <span><i class="fas fa-user-tie me-1"></i> ${givenBy.firstName} ${givenBy.lastName}</span>
                            <span><i class="fas fa-tasks me-1"></i> ${task.title || 'Task'}</span>
                        </div>
                    </div>`;
            });
        }
        
        function loadAppreciationFormData() {
            const employeeSelect = document.getElementById('appreciation-employee');
            const taskSelect = document.getElementById('appreciation-task');
            
            employeeSelect.innerHTML = '<option value="">Select Employee</option>';
            taskSelect.innerHTML = '<option value="">Select Task</option>';
            
            db.getEmployees().filter(e => e.status === 'active').forEach(emp => {
                employeeSelect.innerHTML += `<option value="${emp.id}">${emp.firstName} ${emp.lastName}</option>`;
            });
            
            db.getTasks().filter(t => t.status === 'completed').forEach(task => {
                taskSelect.innerHTML += `<option value="${task.id}">${task.title}</option>`;
            });
        }
        
        function loadAttendanceRecords() {
            const table = document.getElementById('attendance-table');
            table.innerHTML = '';
            
            const month = parseInt(document.getElementById('attendance-month').value);
            const year = parseInt(document.getElementById('attendance-year').value);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let recordsFound = false;
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const record = db.getAttendance().find(a => a.employeeId === currentUser.id && a.date === dateStr);
                
                if(record){
                    recordsFound = true;
                    const clockInParts = record.clockIn.split(':').map(Number);
                    const clockOutParts = record.clockOut.split(':').map(Number);
                    const start = new Date(2000, 0, 1, clockInParts[0], clockInParts[1]);
                    const end = new Date(2000, 0, 1, clockOutParts[0], clockOutParts[1]);
                    const totalHours = ((end - start) / (1000 * 60 * 60)).toFixed(1);
                    const statusBadge = `<span class="badge bg-success">${record.status}</span>`;
                    
                    table.innerHTML += `
                        <tr>
                            <td>${dateStr}</td>
                            <td>${record.clockIn}</td>
                            <td>${record.clockOut}</td>
                            <td>${totalHours} hours</td>
                            <td>${statusBadge}</td>
                        </tr>`;
                }
            }

            if(!recordsFound) {
                table.innerHTML = `<tr><td colspan="5" class="text-center py-3 text-muted">No attendance records for this month.</td></tr>`;
            }
        }
        
        function loadLeaveRequests() {
            const table = document.getElementById('leave-requests-table');
            table.innerHTML = '';
            
            const requests = db.getLeaves().filter(leave => leave.employeeId === currentUser.id).reverse();
            
            if (requests.length === 0) {
                table.innerHTML = `<tr><td colspan="4" class="text-center py-3 text-muted">No leave or WFH requests found.</td></tr>`;
                return;
            }
            
            requests.forEach(req => {
                const statusClasses = { approved: 'success', rejected: 'danger', pending: 'warning'};
                const statusBadge = `<span class="badge bg-${statusClasses[req.status]}">${req.status}</span>`;
                
                table.innerHTML += `
                    <tr>
                        <td>${req.type.toUpperCase()}</td>
                        <td>${req.startDate} to ${req.endDate}</td>
                        <td>${req.reason}</td>
                        <td>${statusBadge}</td>
                    </tr>`;
            });
        }
        
        function loadPendingApprovals() {
            const container = document.getElementById('pending-approvals-table').parentElement.parentElement;
            if (!['admin', 'manager'].includes(currentUser.role)) {
                container.classList.add('d-none');
                return;
            }
            container.classList.remove('d-none');
            
            const table = document.getElementById('pending-approvals-table');
            table.innerHTML = '';
            
            const requests = db.getLeaves().filter(leave => leave.status === 'pending');
            
            if (requests.length === 0) {
                table.innerHTML = `<tr><td colspan="5" class="text-center py-3 text-muted">No pending approvals.</td></tr>`;
                return;
            }
            
            requests.forEach(req => {
                const employee = db.getEmployees().find(e => e.id == req.employeeId) || {};
                
                table.innerHTML += `
                    <tr>
                        <td>${employee.firstName} ${employee.lastName}</td>
                        <td>${req.type.toUpperCase()}</td>
                        <td>${req.startDate} to ${req.endDate}</td>
                        <td>${req.reason}</td>
                        <td>
                            <button class="btn btn-sm btn-success me-1 approve-leave" data-id="${req.id}">Approve</button>
                            <button class="btn btn-sm btn-danger reject-leave" data-id="${req.id}">Reject</button>
                        </td>
                    </tr>`;
            });
            
            document.querySelectorAll('.approve-leave').forEach(btn => btn.addEventListener('click', () => updateLeaveStatus(btn.dataset.id, 'approved')));
            document.querySelectorAll('.reject-leave').forEach(btn => btn.addEventListener('click', () => updateLeaveStatus(btn.dataset.id, 'rejected')));
        }
        
        function loadAnalyticsCharts() {
            ['attendance-chart', 'tasks-chart', 'leave-chart', 'performance-chart'].forEach(id => {
                const chart = Chart.getChart(id);
                if (chart) chart.destroy();
            });

            new Chart(document.getElementById('attendance-chart'), { type: 'bar', data: { labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'], datasets: [{ label: 'Present', data: [22, 24, 23, 25, 24], backgroundColor: '#10b981' }, { label: 'WFH', data: [3, 2, 4, 3, 4], backgroundColor: '#f59e0b' }, { label: 'Absent', data: [1, 0, 0, 0, 2], backgroundColor: '#ef4444' }] }, options: { responsive: true, plugins: { legend: { position: 'top' } } } });
            
            const tasks = db.getTasks();
            new Chart(document.getElementById('tasks-chart'), { type: 'doughnut', data: { labels: ['Completed', 'Assigned', 'Missed'], datasets: [{ data: [tasks.filter(t=>t.status==='completed').length, tasks.filter(t=>t.status==='assigned').length, tasks.filter(t=>t.status==='missed').length], backgroundColor: ['#10b981', '#3b82f6', '#ef4444'] }] }, options: { responsive: true, plugins: { legend: { position: 'top' } } } });
            
            const leaves = db.getLeaves();
            new Chart(document.getElementById('leave-chart'), { type: 'pie', data: { labels: ['Approved', 'Pending', 'Rejected'], datasets: [{ data: [leaves.filter(l=>l.status==='approved').length, leaves.filter(l=>l.status==='pending').length, leaves.filter(l=>l.status==='rejected').length], backgroundColor: ['#10b981', '#f59e0b', '#ef4444'] }] }, options: { responsive: true, plugins: { legend: { position: 'top' } } } });
            
            new Chart(document.getElementById('performance-chart'), { type: 'line', data: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'], datasets: [{ label: 'Performance Score', data: [75, 82, 78, 85, 88, 90, 92], borderColor: '#4361ee', backgroundColor: 'rgba(67, 97, 238, 0.1)', fill: true, tension: 0.3 }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { min: 50, max: 100 } } } });
        }
        
        function loadProfileData() {
            if (!currentUser) return;
            document.getElementById('profile-first-name').value = currentUser.firstName;
            document.getElementById('profile-last-name').value = currentUser.lastName;
            document.getElementById('profile-email').value = currentUser.email;
            document.getElementById('profile-phone').value = currentUser.phone || '';
            document.getElementById('profile-department').value = currentUser.department;
            document.getElementById('profile-dob').value = currentUser.dob || '';
            document.getElementById('profile-address').value = currentUser.address || '';
        }
        
        // =================================================================
        // == HANDLERS & ACTIONS
        // =================================================================
        function openTaskModal() {
            DOMElements.taskForm.reset();
            document.getElementById('task-id').value = '';
            document.getElementById('taskModalTitle').textContent = 'Create New Task';
            
            const assigneeSelect = document.getElementById('task-assignee');
            assigneeSelect.innerHTML = '<option value="">Select Employee</option>';
            db.getEmployees().filter(e => e.status === 'active').forEach(emp => {
                assigneeSelect.innerHTML += `<option value="${emp.id}">${emp.firstName} ${emp.lastName}</option>`;
            });
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('task-deadline').value = tomorrow.toISOString().split('T')[0];
            
            taskModal.show();
        }
        
        function handleSaveTask() {
            const id = document.getElementById('task-id').value;
            let tasks = db.getTasks();
            const taskData = { title: document.getElementById('task-title').value, description: document.getElementById('task-description').value, assignee: parseInt(document.getElementById('task-assignee').value), assignedBy: currentUser.id, deadline: document.getElementById('task-deadline').value, priority: document.getElementById('task-priority').value, status: "assigned" };
            
            if (id) {
                const index = tasks.findIndex(t => t.id == id);
                if (index > -1) tasks[index] = { ...tasks[index], ...taskData };
            } else {
                tasks.push({ id: Date.now(), ...taskData });
            }
            
            db.saveTasks(tasks);
            taskModal.hide();
            showAlert('Task saved successfully.', 'success');
            loadUserTasks();
            loadTeamTasks();
        }
        
        function markTaskComplete(taskId) {
            const tasks = db.getTasks();
            const taskIndex = tasks.findIndex(t => t.id == taskId);
            
            if (taskIndex > -1) {
                tasks[taskIndex].status = "completed";
                tasks[taskIndex].completedOn = new Date().toISOString().split('T')[0];
                db.saveTasks(tasks);
                showAlert('Task marked as completed!', 'success');
                loadUserTasks();
                loadTeamTasks();
            }
        }
        
        function handleSaveAppreciation(e) {
            e.preventDefault();
            const appreciationData = { employeeId: parseInt(document.getElementById('appreciation-employee').value), taskId: parseInt(document.getElementById('appreciation-task').value), note: document.getElementById('appreciation-note').value, givenBy: currentUser.id, date: new Date().toISOString().split('T')[0], public: document.getElementById('appreciation-public').checked };
            
            if(!appreciationData.employeeId || !appreciationData.taskId) {
                showAlert('Please select an employee and a task.', 'warning');
                return;
            }

            const tasks = db.getTasks();
            const taskIndex = tasks.findIndex(t => t.id == appreciationData.taskId);
            if (taskIndex > -1) {
                tasks[taskIndex].appreciation = { note: appreciationData.note, givenBy: appreciationData.givenBy, date: appreciationData.date, public: appreciationData.public };
                db.saveTasks(tasks);
            }
            
            const appreciations = db.getAppreciations();
            appreciations.push({ id: Date.now(), ...appreciationData });
            db.saveAppreciations(appreciations);
            
            showAlert('Appreciation submitted successfully!', 'success');
            DOMElements.appreciationForm.reset();
            loadTeamAppreciations();
            loadRecentAppreciations();
        }
        
        function handleSaveLeave(e) {
            e.preventDefault();
            const leaveData = { employeeId: currentUser.id, type: document.getElementById('leave-type').value, startDate: document.getElementById('leave-start').value, endDate: document.getElementById('leave-end').value, reason: document.getElementById('leave-reason').value, status: "pending" };
            
            const leaves = db.getLeaves();
            leaves.push({ id: Date.now(), ...leaveData });
            db.saveLeaves(leaves);
            
            showAlert('Request submitted successfully!', 'success');
            DOMElements.leaveForm.reset();
            loadLeaveRequests();
        }
        
        function updateLeaveStatus(leaveId, status) {
            const leaves = db.getLeaves();
            const leaveIndex = leaves.findIndex(l => l.id == leaveId);
            
            if (leaveIndex > -1) {
                leaves[leaveIndex].status = status;
                db.saveLeaves(leaves);
                showAlert(`Request has been ${status}!`, 'success');
                loadPendingApprovals();
            }
        }
        
        function handleSaveProfile(e) {
            e.preventDefault();
            const profileData = { firstName: document.getElementById('profile-first-name').value, lastName: document.getElementById('profile-last-name').value, email: document.getElementById('profile-email').value, phone: document.getElementById('profile-phone').value, department: document.getElementById('profile-department').value, dob: document.getElementById('profile-dob').value, address: document.getElementById('profile-address').value };
            
            const employees = db.getEmployees();
            const employeeIndex = employees.findIndex(e => e.id == currentUser.id);
            
            if (employeeIndex > -1) {
                employees[employeeIndex] = { ...employees[employeeIndex], ...profileData };
                db.saveEmployees(employees);
                
                currentUser = employees[employeeIndex];
                db.setCurrentUser(currentUser);
                updateUIForUserRole();
                
                showAlert('Profile updated successfully!', 'success');
            }
        }
        
        function handleChangePassword(e) {
            e.preventDefault();
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (currentPassword !== currentUser.password) { showAlert('Current password is incorrect.', 'danger'); return; }
            if (newPassword !== confirmPassword) { showAlert('New passwords do not match.', 'danger'); return; }
            if (calculatePasswordStrength(newPassword) < 3) { showAlert('New password is too weak.', 'danger'); return; }
            
            const employees = db.getEmployees();
            const employeeIndex = employees.findIndex(e => e.id == currentUser.id);
            
            if (employeeIndex > -1) {
                employees[employeeIndex].password = newPassword;
                db.saveEmployees(employees);
                
                currentUser.password = newPassword;
                db.setCurrentUser(currentUser);
                
                showAlert('Password changed successfully!', 'success');
                DOMElements.passwordForm.reset();
            }
        }
        
        function toggleClock() {
            if (!clockedIn) {
                clockedIn = true;
                clockInTime = new Date();
                DOMElements.clockBtn.textContent = "Clock Out";
                DOMElements.clockBtn.classList.add("clocked-in");
                DOMElements.clockBtn.classList.remove("clocked-out");
                showAlert("Clocked in successfully!", "success");
            } else {
                clockedIn = false;
                const clockOutTime = new Date();
                const hoursWorked = ((clockOutTime - clockInTime) / (1000 * 60 * 60)).toFixed(1);
                
                const attendance = db.getAttendance();
                attendance.push({ employeeId: currentUser.id, date: new Date().toISOString().split('T')[0], clockIn: clockInTime.toTimeString().substring(0, 5), clockOut: clockOutTime.toTimeString().substring(0, 5), status: "present" });
                db.saveAttendance(attendance);
                
                DOMElements.clockBtn.textContent = "Clock In";
                DOMElements.clockBtn.classList.remove("clocked-in");
                DOMElements.clockBtn.classList.add("clocked-out");
                showAlert(`Clocked out. You worked ${hoursWorked} hours today.`, "success");
            }
        }
        
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            alertContainer.appendChild(alert);
            setTimeout(() => {
                const alertInstance = bootstrap.Alert.getOrCreateInstance(alert);
                if (alertInstance) alertInstance.close();
            }, 5000);
        }
        
        function openEmployeeModalForAdd() {
            DOMElements.employeeForm.reset();
            document.getElementById('employee-id').value = '';
            document.getElementById('employeeModalTitle').textContent = 'Add New Employee';
            document.getElementById('status-field-group').classList.add('d-none');
            document.getElementById('password-field-group').classList.remove('d-none');
            document.getElementById('employee-password').required = true;
            employeeModal.show();
        }
        
        function handleSaveEmployee() {
            const id = document.getElementById('employee-id').value;
            let employees = db.getEmployees();
            
            const employeeData = { firstName: document.getElementById('employee-first-name').value, lastName: document.getElementById('employee-last-name').value, email: document.getElementById('employee-email').value, department: document.getElementById('employee-department').value, role: document.getElementById('employee-role').value };
            
            if (id) {
                const index = employees.findIndex(e => e.id == id);
                if (index > -1) {
                    employees[index] = { ...employees[index], ...employeeData, status: document.getElementById('employee-status').value };
                    showAlert('Employee updated successfully.', 'success');
                }
            } else {
                const newEmployee = { id: Date.now(), ...employeeData, password: document.getElementById('employee-password').value, status: 'active', joinDate: new Date().toISOString() };
                employees.push(newEmployee);
                showAlert('Employee created successfully.', 'success');
            }
            
            db.saveEmployees(employees);
            employeeModal.hide();
            loadEmployees();
        }
        
        function loadEmployees() {
            const table = document.getElementById('employees-table');
            table.innerHTML = '';
            const employees = db.getEmployees();
            
            if (employees.length === 0) { table.innerHTML = `<tr><td colspan="6" class="text-center py-3 text-muted">No employees found.</td></tr>`; return; }
            
            employees.forEach(emp => {
                const statusBadge = `<span class="badge bg-${emp.status === 'active' ? 'success' : 'danger'}">${emp.status}</span>`;
                const roleBadge = `<span class="badge role-${emp.role}">${emp.role}</span>`;
                
                table.innerHTML += `
                    <tr>
                        <td>${emp.firstName} ${emp.lastName}</td>
                        <td>${emp.email}</td>
                        <td>${emp.department.replace('-', ' ')}</td>
                        <td>${roleBadge}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary edit-employee" data-id="${emp.id}"><i class="fas fa-edit"></i></button>
                        </td>
                    </tr>`;
            });
            
            document.querySelectorAll('.edit-employee').forEach(btn => btn.addEventListener('click', () => openEmployeeModalForEdit(btn.dataset.id)));
        }
        
        function openEmployeeModalForEdit(employeeId) {
            const employee = db.getEmployees().find(e => e.id == employeeId);
            if (!employee) return;
            
            document.getElementById('employee-id').value = employee.id;
            document.getElementById('employee-first-name').value = employee.firstName;
            document.getElementById('employee-last-name').value = employee.lastName;
            document.getElementById('employee-email').value = employee.email;
            document.getElementById('employee-department').value = employee.department;
            document.getElementById('employee-role').value = employee.role;
            document.getElementById('employee-status').value = employee.status;
            
            document.getElementById('employeeModalTitle').textContent = 'Edit Employee';
            document.getElementById('status-field-group').classList.remove('d-none');
            document.getElementById('password-field-group').classList.add('d-none'); // Don't show password on edit
            document.getElementById('employee-password').required = false;
            
            employeeModal.show();
        }
    </script>
</body>
</html>
